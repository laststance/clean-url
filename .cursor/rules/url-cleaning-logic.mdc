---
globs: utils/*.ts,tests/**/*.ts
description: URL cleaning logic patterns and implementation guidelines
---

# URL Cleaning Logic

## Core Functionality

The `clean-url-logic.ts` module provides comprehensive URL cleaning with:

- **25+ tracking parameter types** removed (UTM, social media, ads, affiliate, email trackers)
- **Essential parameter preservation** (functionality-critical parameters kept)
- **Malformed hash fragment handling** (tracking-like data in URL fragments)
- **Detailed result reporting** with categorized removed parameters and byte savings

## Key Functions

### `cleanUrl(url: string): CleanUrlResult`
Main cleaning function that:
- Validates input URL
- Removes tracking parameters from query strings
- Cleans hash fragments containing tracking data
- Returns structured result with original/cleaned URLs and metadata

### `analyzeUrl(url: string): AnalyzeUrlResult`
Analysis function that:
- Categorizes parameters by type (tracking, essential, unknown)
- Provides detailed breakdown without actually cleaning
- Useful for understanding what would be removed

## Parameter Categories

### Tracking Parameters (Removed)
- **UTM Parameters**: `utm_source`, `utm_medium`, `utm_campaign`, etc.
- **Social Media**: `fbclid`, `gclid`, `msclkid`, `twclid`
- **Email Trackers**: `utm_term`, `mc_eid`, `trk_contact`, `trk_msg`
- **Analytics**: `ga_source`, `ga_medium`, `_ga`, `_gid`
- **Affiliate**: `ref`, `referrer`, `affiliate_id`

### Essential Parameters (Preserved)
- **Functionality**: `q` (search), `page`, `sort`, `filter`
- **Authentication**: `token`, `auth`, `session_id`
- **Configuration**: `lang`, `theme`, `view`

## Error Handling

- **Input validation** for malformed URLs
- **Structured error objects** with error types and messages
- **Graceful degradation** - returns original URL on errors

## Test Coverage

- **93.78% coverage** on core logic
- **Real-world examples** from ConvertKit, GitHub, etc.
- **Edge cases**: Malformed URLs, empty parameters, encoding issues