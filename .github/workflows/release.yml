name: Release

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual publishing)'
        required: false
        default: true
        type: boolean

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Build for Chrome
      run: pnpm build

    - name: Create Chrome ZIP
      run: pnpm zip

    - name: Verify ZIP output
      run: |
        echo "üì¶ Checking .output directory contents:"
        ls -la .output/
        echo "üì¶ ZIP files found:"
        find .output -name "*.zip" -type f

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extension-packages
        path: .output/
        if-no-files-found: error
        include-hidden-files: true
        retention-days: 90

  publish-chrome:
    runs-on: ubuntu-latest
    needs: build-and-package
    if: github.event_name == 'push' || github.event.inputs.dry_run == 'false'
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: extension-packages
        path: .output/

    - name: List downloaded artifacts
      run: |
        echo "üì¶ Downloaded artifacts:"
        ls -la .output/
        find .output -name "*.zip" -type f

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Setup Chrome Web Store credentials
      run: |
        echo "CHROME_EXTENSION_ID=${{ secrets.CHROME_EXTENSION_ID }}" >> .env.submit
        echo "CHROME_CLIENT_ID=${{ secrets.CHROME_CLIENT_ID }}" >> .env.submit
        echo "CHROME_CLIENT_SECRET=${{ secrets.CHROME_CLIENT_SECRET }}" >> .env.submit
        echo "CHROME_REFRESH_TOKEN=${{ secrets.CHROME_REFRESH_TOKEN }}" >> .env.submit

    - name: Submit to Chrome Web Store
      run: |
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "Running in dry-run mode for Chrome Web Store"
          pnpm wxt submit --dry-run --chrome-zip .output/clean-url-*-chrome.zip
        else
          echo "Publishing to Chrome Web Store"
          pnpm wxt submit --chrome-zip .output/clean-url-*-chrome.zip
        fi

  publish-edge:
    runs-on: ubuntu-latest
    needs: build-and-package
    if: (github.event_name == 'push' || github.event.inputs.dry_run == 'false') && vars.ENABLE_EDGE_PUBLISH == 'true'
    timeout-minutes: 10
    continue-on-error: true  # Edge publish is optional

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: extension-packages
        path: .output/

    - name: List downloaded artifacts
      run: |
        echo "üì¶ Downloaded artifacts:"
        ls -la .output/
        find .output -name "*.zip" -type f

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Setup Edge Addons credentials
      run: |
        echo "EDGE_CLIENT_ID=${{ secrets.EDGE_CLIENT_ID }}" >> .env.submit
        echo "EDGE_CLIENT_SECRET=${{ secrets.EDGE_CLIENT_SECRET }}" >> .env.submit
        echo "EDGE_ACCESS_TOKEN_URL=${{ secrets.EDGE_ACCESS_TOKEN_URL }}" >> .env.submit

    - name: Submit to Edge Addons
      run: |
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "Running in dry-run mode for Edge Addons"
          pnpm wxt submit --dry-run --edge-zip .output/clean-url-*-chrome.zip
        else
          echo "Publishing to Edge Addons"
          pnpm wxt submit --edge-zip .output/clean-url-*-chrome.zip
        fi

  notify:
    runs-on: ubuntu-latest
    needs: [publish-chrome]
    if: always() && github.event_name == 'push'

    steps:
    - name: Notify success
      if: needs.publish-chrome.result == 'success'
      run: echo "‚úÖ Extension published successfully to Chrome Web Store"

    - name: Notify failure
      if: needs.publish-chrome.result == 'failure'
      run: echo "‚ùå Chrome Web Store publishing failed"
